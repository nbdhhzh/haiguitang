<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing - Turtle Soup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; }
        .glass-header { 
            background: rgba(9, 9, 11, 0.8); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
        }
        .glass-card { 
            background: rgba(24, 24, 27, 0.4); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        
        /* Markdown Styles for AI */
        .prose p { margin-bottom: 0.5em; }
        .prose p:last-child { margin-bottom: 0; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 950: '#09090b', 900: '#18181b', 850: '#202023' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-zinc-950 text-zinc-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="glass-header fixed top-0 w-full z-20 px-4 py-4 flex justify-between items-center h-16">
        <a href="/" class="group flex items-center text-zinc-400 hover:text-white transition-colors">
            <div class="p-1.5 rounded-full group-hover:bg-zinc-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
            </div>
        </a>
        
        <h1 id="puzzle-title" class="text-sm font-medium tracking-wide text-zinc-200 truncate px-4 opacity-0 transition-opacity duration-500">Loading...</h1>
        
        <div class="flex gap-2">
            <button onclick="markSolved()" class="text-[10px] font-medium tracking-wider uppercase text-emerald-400 hover:text-emerald-300 border border-emerald-900/30 bg-emerald-900/10 hover:bg-emerald-900/20 px-3 py-1.5 rounded-full transition-all">
                Solved
            </button>
            <button onclick="confirmGiveUp()" class="text-[10px] font-medium tracking-wider uppercase text-zinc-500 hover:text-zinc-300 border border-zinc-800 bg-zinc-900 hover:bg-zinc-800 px-3 py-1.5 rounded-full transition-all">
                Give Up
            </button>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-24 pb-32 px-4 space-y-6 no-scrollbar scroll-smooth">
        <!-- Puzzle Content Card -->
        <div id="puzzle-card" class="glass-card p-6 md:p-8 rounded-2xl max-w-2xl mx-auto shadow-sm opacity-0 transition-opacity duration-700">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-1 h-4 bg-emerald-500 rounded-full"></span>
                <span class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Puzzle</span>
            </div>
            <div id="puzzle-content" class="text-lg md:text-xl font-light leading-relaxed text-zinc-200"></div>
        </div>

        <!-- Chat History -->
        <div id="messages" class="max-w-2xl mx-auto space-y-6 pb-4"></div>
        
        <!-- Typing Indicator -->
        <div id="typing" class="hidden max-w-2xl mx-auto flex items-center space-x-1.5 text-zinc-600 pl-4">
            <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce"></div>
            <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce delay-100"></div>
            <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce delay-200"></div>
        </div>
    </main>

    <!-- Input Area -->
    <div class="fixed bottom-0 w-full z-20 pb-6 pt-2 px-4 bg-gradient-to-t from-zinc-950 via-zinc-950/90 to-transparent">
        <form id="chat-form" class="max-w-2xl mx-auto relative group">
            <div class="absolute inset-0 bg-zinc-800/50 rounded-full blur-sm group-hover:bg-zinc-700/50 transition-colors"></div>
            <input type="text" id="user-input" 
                class="relative w-full bg-zinc-900/90 border border-zinc-800 text-zinc-200 rounded-full px-6 py-4 focus:outline-none focus:border-zinc-600 focus:ring-1 focus:ring-zinc-600 transition-all placeholder-zinc-600 shadow-xl"
                placeholder="Ask a Yes/No question..." autocomplete="off">
            
            <button type="submit" 
                class="absolute right-2 top-2 bottom-2 aspect-square bg-zinc-100 hover:bg-white text-black rounded-full transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:scale-100 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </form>
    </div>

    <!-- Modals -->
    <!-- Truth Modal -->
    <div id="truth-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-zinc-950/90 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-zinc-900 rounded-3xl max-w-md w-full p-8 border border-zinc-800 shadow-2xl transform scale-95 transition-transform duration-300 mx-4">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-4 text-zinc-400">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.001 6.001 0 00-5.304-7.65 6 6 0 00-5.304 7.65 12 18v5.25m12-5.25a6.001 6.001 0 015.304-7.65 6 6 0 015.304 7.65 12 18v5.25M12 18a2.25 2.25 0 00-2.25 2.25c0 1.152.26 2.226.714 3.195a2.25 2.25 0 004.14 0c.453-.969.714-2.043.714-3.195A2.25 2.25 0 0012 18z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">The Truth</h2>
                <p class="text-zinc-500 text-sm">Everything is revealed.</p>
            </div>
            
            <div id="truth-content" class="text-zinc-300 mb-8 leading-relaxed text-sm bg-zinc-950/50 p-6 rounded-2xl border border-zinc-800/50"></div>
            
            <button onclick="window.location.href='/'" class="w-full bg-white hover:bg-zinc-200 text-black font-medium py-3.5 rounded-xl transition shadow-lg shadow-white/5">
                Back to Home
            </button>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="rating-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-zinc-950/90 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-zinc-900 rounded-3xl max-w-sm w-full p-8 border border-zinc-800 text-center transform scale-95 transition-transform duration-300 mx-4">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-emerald-500/10 text-emerald-500 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Solved!</h2>
                <p class="text-zinc-500">Rate the quality of this soup</p>
            </div>
            
            <div class="flex justify-center gap-2 mb-8">
                <button onclick="submitRating(1)" class="w-10 h-10 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white transition flex items-center justify-center font-medium">1</button>
                <button onclick="submitRating(2)" class="w-10 h-10 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white transition flex items-center justify-center font-medium">2</button>
                <button onclick="submitRating(3)" class="w-10 h-10 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white transition flex items-center justify-center font-medium">3</button>
                <button onclick="submitRating(4)" class="w-10 h-10 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white transition flex items-center justify-center font-medium">4</button>
                <button onclick="submitRating(5)" class="w-10 h-10 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white transition flex items-center justify-center font-medium">5</button>
            </div>
            
            <button onclick="window.location.href='/'" class="text-zinc-500 hover:text-white text-sm transition-colors">Skip Rating</button>
        </div>
    </div>

    <script>
        const puzzleId = {{ puzzle_id }};
        let sessionId = null;
        let userId = localStorage.getItem('haiguitang_uid');

        if (!userId) {
            // If no user, redirect to home to init auth
            window.location.href = '/';
        }

        async function initGame() {
            try {
                const res = await fetch(`/api/puzzles/${puzzleId}?user_id=${userId}`);
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                
                // Content
                document.getElementById('puzzle-title').innerText = data.puzzle.title;
                document.getElementById('puzzle-content').innerText = data.puzzle.content;
                
                // Animations
                document.getElementById('puzzle-title').classList.remove('opacity-0');
                document.getElementById('puzzle-card').classList.remove('opacity-0');
                
                sessionId = data.session.id;

                // Render History
                const msgs = document.getElementById('messages');
                data.history.forEach(msg => appendMessage(msg.role, msg.content, false));
                
                scrollToBottom();

                if (data.session.status === 'solved') {
                    disableChat('This puzzle is solved.');
                } else if (data.session.status === 'given_up') {
                    disableChat('You gave up on this puzzle.');
                }

            } catch (e) {
                console.error(e);
                document.getElementById('chat-container').innerHTML = 
                    `<div class="flex items-center justify-center h-full text-red-500">Error loading game. Please try again.</div>`;
            }
        }

        function appendMessage(role, content, animate = true) {
            const container = document.getElementById('messages');
            const isUser = role === 'user';
            
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} ${animate ? 'opacity-0 translate-y-2' : ''} transition-all duration-500`;
            
            const bubble = document.createElement('div');
            // High-End Bubble Styles
            if (isUser) {
                bubble.className = `max-w-[85%] rounded-[20px] rounded-br-sm px-5 py-3.5 bg-zinc-100 text-zinc-900 shadow-lg shadow-zinc-900/10 font-medium text-[15px] leading-relaxed`;
                bubble.innerText = content;
            } else {
                bubble.className = `max-w-[85%] rounded-[20px] rounded-bl-sm px-5 py-3.5 bg-zinc-800 border border-zinc-700/50 text-zinc-200 text-[15px] leading-relaxed prose prose-invert prose-p:text-zinc-200`;
                bubble.innerHTML = marked.parse(content);
            }
            
            div.appendChild(bubble);
            container.appendChild(div);
            
            if (animate) {
                // Trigger reflow
                void div.offsetWidth; 
                div.classList.remove('opacity-0', 'translate-y-2');
            }
            
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            // Smooth scroll
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        function disableChat(msg) {
            const input = document.getElementById('user-input');
            input.disabled = true;
            input.placeholder = msg;
            input.classList.add('opacity-50', 'cursor-not-allowed');
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const msg = input.value.trim();
            if (!msg) return;

            appendMessage('user', msg);
            input.value = '';
            
            // Show typing
            document.getElementById('typing').classList.remove('hidden');
            scrollToBottom();

            try {
                const res = await fetch('/api/game/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, message: msg })
                });
                
                if (!res.ok) throw new Error('API Error');
                
                const data = await res.json();
                document.getElementById('typing').classList.add('hidden');
                appendMessage(data.role, data.content);

            } catch (err) {
                document.getElementById('typing').classList.add('hidden');
                // Optional: Show error toast
                console.error(err);
            }
        };

        // --- Logic for Modals ---

        function markSolved() {
            const modal = document.getElementById('rating-modal');
            modal.classList.remove('hidden');
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0');
        }

        async function submitRating(rating) {
            try {
                const res = await fetch('/api/game/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, rating: rating })
                });
                if (res.ok) {
                    window.location.href = '/';
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function confirmGiveUp() {
            if (confirm('Are you sure you want to see the truth?')) {
                const res = await fetch('/api/game/giveup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, rating: 0 })
                });
                const data = await res.json();
                
                const modal = document.getElementById('truth-modal');
                document.getElementById('truth-content').innerText = data.truth;
                
                modal.classList.remove('hidden');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                
                disableChat('Game Over');
            }
        }
        
        // Start
        initGame();

    </script>
</body>
</html>
